/* STEP 1: Summarize Total Loss at the Quarterly Level in Deduplicated Table */
proc sql;
    create table dedup_quarterly as
    select 
        gl_date,
        sum(input(net_loss, best32.)) as sum_loss_dedup  /* Summing net loss after deduplication */
    from event_w_exclusion_dedup
    group by gl_date
    order by gl_date;
quit;

/* STEP 2: Extract Severity at the Quarterly Level from Aggregated Table */
proc sql;
    create table agg_quarterly as
    select 
        gl_date,
        sum(input(severity, best32.)) as sum_loss_agg  /* Summing severity after aggregation */
    from event_w_exclusion_agg
    group by gl_date
    order by gl_date;
quit;

/* STEP 3: Compare Deduplicated vs. Aggregated Losses */
proc sql;
    create table loss_discrepancy as
    select 
        a.gl_date,
        a.sum_loss_dedup,
        b.sum_loss_agg,
        b.sum_loss_agg - a.sum_loss_dedup as difference
    from dedup_quarterly a
    full join agg_quarterly b
    on a.gl_date = b.gl_date
    order by gl_date;
quit;
