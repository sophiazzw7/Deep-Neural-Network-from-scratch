/*************************************************************/
/* Step 4 (Optimized): Validate Aggregation Step */
/*************************************************************/

/* Precompute sum of net loss by quarter from event_w_exclusion_dedup */
proc sql;
    create table dedup_quarterly as
    select qtr_event, sum(net_loss) as sum_dedup
    from event_w_exclusion_dedup
    group by qtr_event;
quit;

/* Create an index to speed up joins */
proc datasets library=work;
    modify dedup_quarterly;
    index create qtr_event;
quit;

/* Compare with aggregated severity from event_w_exclusion_agg */
proc sql;
    create table validate_aggregation as
    select a.qtr_event, 
           a.sum_dedup,
           b.severity as sum_agg,
           a.sum_dedup - b.severity as difference
    from dedup_quarterly a
    left join event_w_exclusion_agg b
    on a.qtr_event = b.qtr_event;
quit;

/* Print only quarters with significant discrepancies */
proc print data=validate_aggregation;
    where abs(difference) > 10000; /* Adjust threshold as needed */
    title "Quarters with Net Loss Discrepancies (Dedup vs. Aggregation)";
run;
