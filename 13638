data cpbp_model_data;
    merge mev_data cpbp_hist;
    by data_date;
run;

data ef_model_data;
    merge mev_data ef_hist;
    by data_date;
run;

proc genmod data=cpbp_model_data;
    model actual_frequency = SP500_Vol_MAVG_Ydiff GDP_Real_Lag2
        / dist=NEGBIN link=log;
    output out=NEGBINFIT_CPBP p=lambda reschi=reschi;
    ods output ParameterEstimates = WORK.CPBP_PE
               Obstats            = WORK.CPBP_OBS_QTR
               ModelFit           = WORK.CPBP_P_MODELFIT;
    store out=cpbp_nbmodel;
run;

proc genmod data=ef_model_data;
    model actual_frequency = Fin_Act_Employment_qoq 
                             Consumer_Credit_lag1
                             DOWJ_Total_qoq
        / dist=NEGBIN link=log;
    output out=NEGBINFIT_EF p=lambda reschi=reschi;
    ods output ParameterEstimates = WORK.EF_PE
               Obstats            = WORK.EF_OBS_QTR
               ModelFit           = WORK.EF_P_MODELFIT;
    store out=ef_nbmodel;
run;

proc means data=cpbp_model_data noprint;
    var SP500_Vol_MAVG_Ydiff 
        GDP_Real_Lag2;
    output out=cpbp_meanstd
           mean= mean_sp500 mean_gdp
           std=  std_sp500  std_gdp;
run;

proc means data=ef_model_data noprint;
    var Fin_Act_Employment_qoq
        Consumer_Credit_lag1
        DOWJ_Total_qoq;
    output out=ef_meanstd
           mean= mean_Fin mean_Credit mean_Dow
           std=  std_Fin  std_Credit  std_Dow;
run;

data cpbp_scenarios;
    set cpbp_meanstd;
    length scenario $50;
    scenario = 'CPBP_Baseline';
    SP500_Vol_MAVG_Ydiff = mean_sp500;
    GDP_Real_Lag2        = mean_gdp;
    output;
    array spShocks[4] (1,2,3,4);
    do i=1 to 4;
        scenario = cats('SP500_-', spShocks[i], 'STD');
        SP500_Vol_MAVG_Ydiff = mean_sp500 - spShocks[i]*std_sp500;
        GDP_Real_Lag2        = mean_gdp;
        output;
        scenario = cats('SP500_+', spShocks[i], 'STD');
        SP500_Vol_MAVG_Ydiff = mean_sp500 + spShocks[i]*std_sp500;
        GDP_Real_Lag2        = mean_gdp;
        output;
    end;
    array gdpShocks[4] (1,2,3,4);
    do j=1 to 4;
        scenario = cats('GDP_-', gdpShocks[j], 'STD');
        SP500_Vol_MAVG_Ydiff = mean_sp500;
        GDP_Real_Lag2        = mean_gdp - gdpShocks[j]*std_gdp;
        output;
        scenario = cats('GDP_+', gdpShocks[j], 'STD');
        SP500_Vol_MAVG_Ydiff = mean_sp500;
        GDP_Real_Lag2        = mean_gdp + gdpShocks[j]*std_gdp;
        output;
    end;
run;

data ef_scenarios;
    set ef_meanstd;
    length scenario $50;
    scenario = 'EF_Baseline';
    Fin_Act_Employment_qoq = mean_Fin;
    Consumer_Credit_lag1   = mean_Credit;
    DOWJ_Total_qoq         = mean_Dow;
    output;
    array myShocks[4] (1,2,3,4);
    do i=1 to 4;
        scenario = cats('Fin_-', myShocks[i], 'STD');
        Fin_Act_Employment_qoq = mean_Fin - myShocks[i]*std_Fin;
        Consumer_Credit_lag1   = mean_Credit;
        DOWJ_Total_qoq         = mean_Dow;
        output;
        scenario = cats('Fin_+', myShocks[i], 'STD');
        Fin_Act_Employment_qoq = mean_Fin + myShocks[i]*std_Fin;
        Consumer_Credit_lag1   = mean_Credit;
        DOWJ_Total_qoq         = mean_Dow;
        output;
    end;
    do i=1 to 4;
        scenario = cats('Credit_-', myShocks[i], 'STD');
        Fin_Act_Employment_qoq = mean_Fin;
        Consumer_Credit_lag1   = mean_Credit - myShocks[i]*std_Credit;
        DOWJ_Total_qoq         = mean_Dow;
        output;
        scenario = cats('Credit_+', myShocks[i], 'STD');
        Fin_Act_Employment_qoq = mean_Fin;
        Consumer_Credit_lag1   = mean_Credit + myShocks[i]*std_Credit;
        DOWJ_Total_qoq         = mean_Dow;
        output;
    end;
    do i=1 to 4;
        scenario = cats('DOW_-', myShocks[i], 'STD');
        Fin_Act_Employment_qoq = mean_Fin;
        Consumer_Credit_lag1   = mean_Credit;
        DOWJ_Total_qoq         = mean_Dow - myShocks[i]*std_Dow;
        output;
        scenario = cats('DOW_+', myShocks[i], 'STD');
        Fin_Act_Employment_qoq = mean_Fin;
        Consumer_Credit_lag1   = mean_Credit;
        DOWJ_Total_qoq         = mean_Dow + myShocks[i]*std_Dow;
        output;
    end;
run;

proc plm restore=cpbp_nbmodel;
    score data=cpbp_scenarios out=cpbp_scored predicted=pred_freq / ilink;
run;

proc plm restore=ef_nbmodel;
    score data=ef_scenarios out=ef_scored predicted=pred_freq / ilink;
run;

proc sql;
    create table cpbp_sens as
    select a.scenario,
           a.SP500_Vol_MAVG_Ydiff,
           a.GDP_Real_Lag2,
           a.pred_freq as scenario_pred,
           b.pred_freq as baseline_pred,
           (a.pred_freq - b.pred_freq) as diff_freq,
           ((a.pred_freq - b.pred_freq)/b.pred_freq) as pct_diff format=percent8.2
    from cpbp_scored as a
    left join cpbp_scored as b
         on b.scenario = 'CPBP_Baseline';
quit;

proc sql;
    create table ef_sens as
    select a.scenario,
           a.Fin_Act_Employment_qoq,
           a.Consumer_Credit_lag1,
           a.DOWJ_Total_qoq,
           a.pred_freq as scenario_pred,
           b.pred_freq as baseline_pred,
           (a.pred_freq - b.pred_freq) as diff_freq,
           ((a.pred_freq - b.pred_freq)/b.pred_freq) as pct_diff format=percent8.2
    from ef_scored as a
    left join ef_scored as b
         on b.scenario = 'EF_Baseline';
quit;

proc print data=cpbp_sens noobs label;
    var scenario SP500_Vol_MAVG_Ydiff GDP_Real_Lag2 scenario_pred baseline_pred diff_freq pct_diff;
    label scenario_pred = "Scenario Pred Freq"
          baseline_pred = "Baseline Pred Freq"
          diff_freq     = "Absolute Difference"
          pct_diff      = "% Diff vs Baseline";
run;

%let output_path = /your/path/here;
proc export data=cpbp_sens
    outfile="&output_path/cpbp_sensitivity.xlsx"
    dbms=xlsx replace;
    sheet="CPBP_Sens";
run;

proc print data=ef_sens noobs label;
    var scenario Fin_Act_Employment_qoq Consumer_Credit_lag1 DOWJ_Total_qoq scenario_pred baseline_pred diff_freq pct_diff;
    label scenario_pred = "Scenario Pred Freq"
          baseline_pred = "Baseline Pred Freq"
          diff_freq     = "Absolute Difference"
          pct_diff      = "% Diff vs Baseline";
run;

proc export data=ef_sens
    outfile="&output_path/ef_sensitivity.xlsx"
    dbms=xlsx replace;
    sheet="EF_Sens";
run;
